<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
    <meta name="description" content="我连一秒都没有拥有过他，却感觉失去过他千万次">
  

  
    <meta name="keywords" content="best">
  

  
    <meta name="author" content="dandan">
  

  
    <meta name="copyright" content="zhaodan">
  

  

  <title>harbor调研 | 蛋蛋的笔记本</title>

  

  
    <link rel="icon" href="/favicon.ico">
  

  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/highlight.js/9.15.6/styles/monokai.min.css" rel="stylesheet">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>
<body>
  <div class="root-container">
    <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          蛋蛋的笔记本
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">HOME</a></li>
        
          <li class="navbar-list-item"><a href="/about">ABOUT</a></li>
        
          <li class="navbar-list-item"><a href="/tags">TAGS</a></li>
        
          <li class="navbar-list-item"><a href="/categories">CATEGORIES</a></li>
        
      </ul>
    </div>
  </div>
</nav>

    
<!-- header container -->
<header class="header-container post">

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-image" style="background-image: url(https://qiniu.miiiku.xyz/src/images/banner.jpg)"></div>
      <div class="post-text">
        <div class="type-wrap">
          
        </div>
        <h1 class="title-wrap">harbor调研</h1>
        <h2 class="title-sub-wrap">
          <strong>dandan</strong>
          <span>发布于</span>
          
  <a href="javascript:;" class="article-date">
    <time datetime="2020-03-01T16:00:00.000Z" itemprop="datePublished">2020-03-02</time>
  </a>

        </h2>
      </div>
    </div>
  

  
  

  </header>

    <!-- 文章 -->

<!-- 文章内容 -->

<div class="body-container">
  <article class="content-container article-container">
    <div class="article-content">
      
      

      <section class="article-entry">
        <p>前提： 因为公司想要将线上服务统一使用K8s进行部署，那之前的tar安装包就成了images，因此要考虑新的存储方案。结合github信息和网友的使用经验，整理出了以下harbor信息。</p>
<p>开源镜像存储仓库<br>私有化的镜像部署<br>官方的说法是：Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器。通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源Docker Distribution。作为一个企业级私有Registry服务器，Harbor提供了更好的性能和安全。提升用户使用Registry构建和运行环境传输镜像的效率。</p>
<p>harbor存在的原因：</p>
<ol>
<li>提供分层传输机制，优化网络传输<br>Docker镜像是是分层的，如果每次传输都使用全量文件显然不经济，所以用FTP的方式并不适合。必须提供识别分层传输的机制，以层的UUID为标识，确定传输的对象。</li>
<li>提供WEB界面，优化用户体验<br>只用镜像的名字来进行上传下载显然很不方便，需要有一个用户界面可以支持登陆、搜索功能，包括区分公有、私有镜像。</li>
<li>支持水平扩展集群<br>当有用户对镜像的上传下载操作集中在某服务器，需要对相应的访问压力作分解。上面这些就是Docker Registry所完成的主要工作，而Habor在此之上，又提供了用户、同步等诸多特性。<br>Harbor两个容易误解的点：</li>
<li>harbor功能<br>镜像的存储harbor使用的是官方的docker registry服务去完成，至于registry是用本地存储或者s3都是可以的，harbor的功能是在此之上提供用户权限管理、镜像复制等功能，提高使用的registry的效率。</li>
<li>镜像复制<br>通过docker registry 的API去拷贝，这种做法屏蔽了繁琐的底层文件操作、不仅可以利用现有docker registry功能不必重复造轮子，而且可以解决冲突和一致性的问题。<br>harbor的组件及功能：</li>
</ol>
<p>组件<br>功能<br>proxy<br>nginx前端代理，主要分发前端页面ui访问、镜像上传下载流量<br>ui<br>提供了一个web管理页面，包括前端页面和后端API，底层使用mysql数据库<br>registry<br>镜像仓库，负责存储镜像文件，当镜像上传完毕后通过hook通知ui创建repository， registry的token认证通过ui组件完成<br>adminserver<br>系统的配置管理中心附带检查存储用量，ui和jobserver启动时候需要加载adminserver的配置<br>jobserver<br>负责镜像复制工作，和registry通信，从一个registry pull镜像push到另一个registry，并记录job log<br>log<br>日志汇总组件，通过docker的log-driver把日志汇总到一起</p>
<p>功能优点：<br>用户管理三种角色：在最高管理员权限系统管理员admin外还有，项目管理员 MDRWS 、开发人员 RWS 、访客 RS 、<br>项目管理：项目是一组镜像仓库的逻辑集合，是权限管理和资源管理的单元划分。一个项目下面有多个镜像仓库，并且关联多个不同角色的成员，镜像复制也是基于项目的，通过添加复制规则，可以将项目下面的镜像从一个harbor迁移到另一个harbor，通过日志可查看复制过程，并有retry机制。<br>配置管理、日志查询：配置管理主要是配置harbor的认证模式，企业内部使用，通常都是对接到公司LDAP上面，harbor也支持数据库认证，可以设置token的有效时间。用户对镜像的pull和push操作都可以被harbor记录下来。<br>优点：<br>        本身自带 docker 私有仓库<br>        支持基于角色的权限管理<br>        支持 LDAP<br>安装环境：<br>        支持k8s的helm安装和本地安装<br>        需要安装docker并运行<br>        docker-compose<br>        docker engine<br>        Harbor offline installer<br>        redis<br>        mysql<br>        Openssl<br>要求：<br>        最低配置要求2核4G40G<br>        需要开放443 4443 80端口 https http<br>        生产环境中建议使用https</p>
<hr>
<p>应用：<br>        我们在当前的企业应用中，Docker的镜像仓库配置成harbor，在容器启动是会拉取harbor中的镜像。在实际使用过程中，一个镜像库可能是不够用的，下例情况下我们可能会需要部署多个镜像仓库：<br>        1. 国外的公有镜像下载过慢，需要一个中转仓库进行加速<br>        2. 容器规模较大，一个镜像仓库不堪重负<br>        3. 对系统稳定性要求高，需要多个仓库保证高可用性<br>        4. 镜像仓库有多级规划，下级仓库依赖上级仓库<br>集群考虑：<br>        一致性<br>        实时性<br>        可用性<br>应用场景的考虑：<br>        1. 国内地区和海外地区的harbor统一还是分开、如果统一，优点、难点，如果分开，优点、难点<br>        2. 国内业务和海外业务是否有关联性会互相影响<br>        3.海外是否会受网络影响速度<br>海内外统一harbor：<br>        优点：统一镜像管理、统一权限管理、节省服务器成本<br>        难点：选择节点、节点之间通信、网络速度、项目管理<br>海内外harbor分开：<br>        优点：集群架构简单、集群节点通信无阻碍、没有网络延迟问题<br>        难点：集群分开管理<br>目标：容灾备份<br>目前有两种主流的方案解决这个问题：<br>双主复制<br>多harbor实例共享后端存储<br>双主复制：双主复制其实就是复用主从同步，实现两个harbor节点之间的双向同步，来保证数据的一致性，然后在两台harbor前端顶一个负载均衡器，将进来的请求分流到不同的实例中去，只要有一个实例中有了新的镜像，就自动的同步复制到另外的的实例中去，这样实现了负载均衡，也避免了单点故障，在一定程度上实现了Harbor的高可用性。<br>问题：可能会存在数据不一致问题，需要手动重启复制策略才能再次进行同步。<br>多harbor实例共享后端存储：共享后端存储算就是多个Harbor实例共享同一个后端存储，任何一个实例持久化到存储的镜像，都可被其他实例中读取。通过前置LB进来的请求，可以分流到不同的实例中去处理，这样就实现了负载均衡，也避免了单点故障。</p>
<p>在实际生产环境中部署需要考虑三个问题：</p>
<ol>
<li>选取共享存储，Harbor的后端存储目前支持AWS S3、OSS 、Openstack Swift, Ceph等。</li>
<li>Session在不同的实例上共享，在最新的harbor中，默认session会存放在redis中，我们只需要将redis独立出来即可。可以通过redis sentinel或者redis cluster等方式来保证redis的可用性。</li>
<li>Harbor多实例数据库问题，将harbor中的数据库拆出来独立部署即可。让多实例共用一个外部数据库，数据库的高可用也可以通过数据库的高可用方案保证。<br>harbor高可用部署：<pre><code>通过三个harbor完成高可用部署，通过负载均衡器对外提供服务，共享数据库与缓存。</code></pre><a href="https://postimg.cc/G9RR7wKB" target="_blank" rel="noopener"><img src="https://i.postimg.cc/2jb55CBx/harbor.png" alt="harbor.png"></a></li>
</ol>
<p>github：<a href="https://github.com/goharbor/harbor/blob/v1.10.0/README.md" target="_blank" rel="noopener">https://github.com/goharbor/harbor/blob/v1.10.0/README.md</a><br><a href="https://github.com/goharbor/harbor/blob/v1.10.0/docs/installation_guide.md" target="_blank" rel="noopener">https://github.com/goharbor/harbor/blob/v1.10.0/docs/installation_guide.md</a><br><a href="https://github.com/goharbor/harbor/tree/master/docs/1.10" target="_blank" rel="noopener">https://github.com/goharbor/harbor/tree/master/docs/1.10</a><br>demo： <a href="https://demo.goharbor.io/harbor/projects" target="_blank" rel="noopener">https://demo.goharbor.io/harbor/projects</a><br>参考文档：<a href="https://www.kubernetes.org.cn/1738.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/1738.html</a><br><a href="https://tonybai.com/2017/06/09/setup-a-high-availability-private-registry-based-on-harbor-and-cephfs/" target="_blank" rel="noopener">https://tonybai.com/2017/06/09/setup-a-high-availability-private-registry-based-on-harbor-and-cephfs/</a></p>

      </section>

      <section class="article-footer">
        
      </section>

      <section class="article-navs">
        
<nav class="card-container card-article-nav">
  <div class="card-wrap">
    
      <div id="article-nav-newer" class="card-item">
        <article>
          
          <a class="card-link article-nav-link" href="/2020/03/05/64_harbor2/"></a>
          <strong class="article-nav-caption">Newer</strong>
          <p class="article-nav-title">
            
              harborV1.10.1 共享存储库预演测试
            
          </p>
        </article>
      </div>
    
    
      <div id="article-nav-older" class="card-item">
        <article>
          
          <a class="card-link article-nav-link" href="/2020/02/24/62_jenkins%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85maven%E9%A1%B9%E7%9B%AE%E8%B8%A9%E5%9D%91/"></a>
          <strong class="article-nav-caption">Older</strong>
          <p class="article-nav-title">
            
              jenkins自动打包maven类型项目踩坑记录
            
          </p>
        </article>
      </div>
    
  </div>
</nav>

      </section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons social-icons-footer">
      <a href="mailto:zhaodanwjk@163.com" target="_blank" rel="noopener noreferrer">
  <svg class="icon icon-email" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M490.338462 592.738462c11.815385 11.815385 29.538462 11.815385 41.353846 0l445.046154-413.538462c7.876923-15.753846 5.907692-41.353846-25.6-41.353846l-880.246154 1.969231c-23.630769 0-43.323077 21.661538-25.6 41.353846l445.046154 411.569231zM984.615385 340.676923c0-19.692308-23.630769-31.507692-39.384616-17.723077L596.676923 643.938462c-23.630769 21.661538-53.169231 33.476923-84.676923 33.476923s-61.046154-11.815385-84.676923-31.507693L80.738462 322.953846c-15.753846-13.784615-39.384615-3.938462-39.384616 17.723077C39.384615 334.769231 39.384615 787.692308 39.384615 787.692308c0 43.323077 35.446154 78.769231 78.769231 78.76923h787.692308c43.323077 0 78.769231-35.446154 78.769231-78.76923V340.676923z"></path>
  </svg>
</a><a href="https://www.instagram.com/hello_missdawn/" target="_blank" rel="noopener noreferrer">
  <svg class="icon icon-ins" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M512 0C372.906667 0 355.541333 0.64 300.928 3.072 246.4 5.632 209.28 14.208 176.64 26.88c-33.664 13.056-62.250667 30.592-90.709333 59.050667S39.893333 142.933333 26.88 176.64C14.208 209.28 5.589333 246.4 3.072 300.928 0.512 355.541333 0 372.906667 0 512s0.64 156.458667 3.072 211.072c2.56 54.485333 11.136 91.648 23.808 124.288a251.093333 251.093333 0 0 0 59.050667 90.709333A250.368 250.368 0 0 0 176.64 997.12c32.682667 12.629333 69.802667 21.290667 124.288 23.808C355.541333 1023.488 372.906667 1024 512 1024s156.458667-0.64 211.072-3.072c54.485333-2.56 91.648-11.178667 124.288-23.808a251.648 251.648 0 0 0 90.709333-59.050667 250.026667 250.026667 0 0 0 59.050667-90.709333c12.629333-32.64 21.290667-69.802667 23.808-124.288 2.56-54.613333 3.072-71.978667 3.072-211.072s-0.64-156.458667-3.072-211.072c-2.56-54.485333-11.178667-91.690667-23.808-124.288a251.306667 251.306667 0 0 0-59.050667-90.709333A249.472 249.472 0 0 0 847.36 26.88c-32.64-12.672-69.802667-21.290667-124.288-23.808C668.458667 0.512 651.093333 0 512 0z m0 92.16c136.661333 0 152.96 0.682667 206.933333 3.029333 49.92 2.346667 77.013333 10.624 95.018667 17.706667 23.978667 9.258667 40.96 20.352 58.965333 38.229333 17.877333 17.92 28.970667 34.944 38.229334 58.922667 6.997333 18.005333 15.36 45.098667 17.621333 95.018667 2.432 54.016 2.986667 70.229333 2.986667 206.933333s-0.64 152.96-3.157334 206.933333c-2.602667 49.92-10.922667 77.013333-17.962666 95.018667a162.56 162.56 0 0 1-38.357334 58.965333 159.744 159.744 0 0 1-58.88 38.229334c-17.92 6.997333-45.44 15.36-95.36 17.621333-54.357333 2.432-70.357333 2.986667-207.317333 2.986667-137.002667 0-153.002667-0.64-207.317333-3.157334-49.962667-2.602667-77.482667-10.922667-95.402667-17.962666a158.549333 158.549333 0 0 1-58.837333-38.357334 155.477333 155.477333 0 0 1-38.4-58.88c-7.04-17.92-15.317333-45.44-17.92-95.36-1.92-53.76-2.602667-70.357333-2.602667-206.677333 0-136.362667 0.682667-153.002667 2.602667-207.402667 2.602667-49.92 10.88-77.397333 17.92-95.317333 8.96-24.32 20.437333-40.96 38.4-58.922667 17.877333-17.877333 34.56-29.397333 58.837333-38.314666 17.92-7.082667 44.842667-15.402667 94.762667-17.962667 54.4-1.92 70.4-2.56 207.317333-2.56l1.92 1.28z m0 156.928a262.912 262.912 0 1 0 0 525.824 262.912 262.912 0 1 0 0-525.824zM512 682.666667c-94.293333 0-170.666667-76.373333-170.666667-170.666667s76.373333-170.666667 170.666667-170.666667 170.666667 76.373333 170.666667 170.666667-76.373333 170.666667-170.666667 170.666667z m334.762667-443.946667a61.482667 61.482667 0 0 1-122.88 0 61.44 61.44 0 0 1 122.88 0z"></path>
  </svg>
</a>
    </div>
     
    <p>&copy; 2020 <a href="/" target="_blank">dandan</a></p>

    
      <p id="hitokoto"></p>
      <script src="https://v1.hitokoto.cn/?c=c&amp;encode=js&select=%23hitokoto" defer></script>
    

    

    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank">flex-block</a></p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
  <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
  <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
</svg> 
  </div>

  
  
<!-- valine 评论 start -->
<script type="text/javascript" src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script type="text/javascript">
  new Valine({
    el: "#valine_thread",
    appId: "1x2m86DzLyVjjvrAd28PlcHP-9Nh9j0Va",
    appKey: "rOyvhDLkseoPCv9tY592cNVW",
    avatar: "mm",
    placeholder: "随便说点什么叭～",
    notify: true,
    visitor: true,
    pageSize: 10,
  });
</script>
<!-- valine 评论 end -->



  <!-- aplayer 音频 start -->
  
<link rel="stylesheet" href="/lib/APlayer.min.css">

  
<script src="/lib/APlayer.min.js"></script>

  <script type="text/javascript">
    const aplayer = document.querySelectorAll(".aplayer");
    aplayer && initaplayer(aplayer);
    function initaplayer(els) {
      let elsArr = Array.from(els);
      elsArr.forEach(el => {
        new APlayer({
          container: el,
          audio: { ...el.dataset },
          theme: "#b7daff",
          lrcType: 3,
          autoplay: false,
          loop: false,
          mutex: true,
        });
      });
    }
  </script>
  <!-- aplayer 音频 end -->
  

<!-- dplayer 视频 start -->

<link rel="stylesheet" href="/lib/DPlayer.min.css">


<script src="/lib/DPlayer.min.js"></script>

<script type="text/javascript">
  const dplayer = document.querySelectorAll(".dplayer");
  dplayer && initDPlayer(dplayer);
  function initDPlayer(els) {
    let elsArr = Array.from(els);
    elsArr.forEach(el => {
      let url = el.dataset.url;
      let cover = el.dataset.cover;
      new DPlayer({
        container: el,
        video: { url: url, pic: cover },
        theme: "#b7daff",
        autoplay: false,
        loop: false,
        mutex: true,
      });
    });
  }
</script>
<!-- dplayer 视频 end -->


<!-- waterfall 瀑布流 start -->

<script src="/lib/waterfall.min.js"></script>

<script type="text/javascript">

const waterfalls = document.querySelectorAll(".waterfall-container");

if (waterfalls && waterfalls.length > 0) {
  waterfalls.forEach((waterfall, index) => {
    let cls = "waterfall-container-" + index;
    waterfall.classList.add(cls);
    initWaterfall(cls, waterfall);
  });
}

function initWaterfall(selector, el) {
  const options = {};
  if (Object.keys(el.dataset).length > 0) {
    for (let k in el.dataset) {
      options[k] = el.dataset[k];
    }
  }
  waterfall(`.${selector}`, options);
}
</script>
<!-- waterfall 瀑布流 end -->


  <!-- zoom start -->
  
<script src="/lib/zoom.min.js"></script>

  <script type="text/javascript">
    document.querySelector(".article-content") && zoom(".article-content");
  </script>
  <!-- zoom end -->
  



  


  


  




<script src="/js/script.js"></script>

  
  <!-- 尾部用户自定义相关内容 -->

</body>
</html>
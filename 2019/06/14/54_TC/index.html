<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
    <meta name="description" content="我连一秒都没有拥有过他，却感觉失去过他千万次">
  

  
    <meta name="keywords" content="best">
  

  
    <meta name="author" content="dandan">
  

  
    <meta name="copyright" content="zhaodan">
  

  

  <title>TeamCity还原备份数据及升级文档 | 蛋蛋的笔记本</title>

  

  
    <link rel="icon" href="/favicon.ico">
  

  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/highlight.js/9.15.6/styles/monokai.min.css" rel="stylesheet">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>
<body>
  <div class="root-container">
    <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          蛋蛋的笔记本
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">HOME</a></li>
        
          <li class="navbar-list-item"><a href="/about">ABOUT</a></li>
        
          <li class="navbar-list-item"><a href="/tags">TAGS</a></li>
        
          <li class="navbar-list-item"><a href="/categories">CATEGORIES</a></li>
        
      </ul>
    </div>
  </div>
</nav>

    
<!-- header container -->
<header class="header-container post">

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-image" style="background-image: url(https://qiniu.miiiku.xyz/src/images/banner.jpg)"></div>
      <div class="post-text">
        <div class="type-wrap">
          
        </div>
        <h1 class="title-wrap">TeamCity还原备份数据及升级文档</h1>
        <h2 class="title-sub-wrap">
          <strong>dandan</strong>
          <span>发布于</span>
          
  <a href="javascript:;" class="article-date">
    <time datetime="2019-06-13T16:00:00.000Z" itemprop="datePublished">2019-06-14</time>
  </a>

        </h2>
      </div>
    </div>
  

  
  

  </header>

    <!-- 文章 -->

<!-- 文章内容 -->

<div class="body-container">
  <article class="content-container article-container">
    <div class="article-content">
      
      

      <section class="article-entry">
        <p>没有用过TC因为工作需求现读官方文档做备份还原等操作，以下是我读参考文档的顺序（建议新手读文档一步一步了解）：</p>
<p>查看版本信息<br><a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" target="_blank" rel="noopener">https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads</a><br>安装与启动<br><a href="https://confluence.jetbrains.com/display/TCD18/Installation+Quick+Start#InstallationQuickStart-onLinuxandOSX" target="_blank" rel="noopener">https://confluence.jetbrains.com/display/TCD18/Installation+Quick+Start#InstallationQuickStart-onLinuxandOSX</a><br>主目录介绍<br><a href="https://confluence.jetbrains.com/display/TCD10/TeamCity+Data+Directory" target="_blank" rel="noopener">https://confluence.jetbrains.com/display/TCD10/TeamCity+Data+Directory</a><br>数据库<br><a href="https://confluence.jetbrains.com/display/TCD18/Setting+up+an+External+Database" target="_blank" rel="noopener">https://confluence.jetbrains.com/display/TCD18/Setting+up+an+External+Database</a><br>备份还原<br><a href="https://confluence.jetbrains.com/display/TCD18/Restoring+TeamCity+Data+from+Backup" target="_blank" rel="noopener">https://confluence.jetbrains.com/display/TCD18/Restoring+TeamCity+Data+from+Backup</a></p>
<hr>
<p>操作步骤：</p>
<p>环境说明：在内网开一台测试机，脱离生产环境进行备份还原操作</p>
<p>新建目录下载生产环境中使用的相同version压缩包：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># mkdir /data</span><br><span class="hljs-meta"># cd /data/</span><br><span class="hljs-meta"># wget https://download.jetbrains.8686c.com/teamcity/TeamCity-10.0.1.tar.gz</span><br></code></pre></td></tr></table></figure>

<p>连接服务器获取TC备份数据到测试机：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">scp -<span class="hljs-selector-tag">i</span> XXX<span class="hljs-selector-class">.pem</span>  TeamCity_Backup_20190612_151253<span class="hljs-selector-class">.zip</span> ec2-user@<span class="hljs-number">52.82</span><span class="hljs-selector-class">.XX</span><span class="hljs-selector-class">.XX</span>:/tmp<br></code></pre></td></tr></table></figure>

<p>安装MySQL并创建数据库：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"># yum install mysql-server mysql<br># mysql<br>mysql&gt; <span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> teamcity <span class="hljs-keyword">collate</span> utf8_bin;<br>mysql&gt; <span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> restoretc <span class="hljs-keyword">collate</span> utf8_bin;<br>mysql&gt; <span class="hljs-keyword">update</span> mysql.<span class="hljs-keyword">user</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">password</span>=<span class="hljs-keyword">PASSWORD</span>(<span class="hljs-string">'password'</span>) <span class="hljs-keyword">where</span> <span class="hljs-keyword">User</span>=<span class="hljs-string">'root’;</span><br><span class="hljs-string">mysql&gt; flush privileges;</span><br></code></pre></td></tr></table></figure>

<p>升级Java版本:</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vala">如果已经有低版本Java需卸载再安装<br><span class="hljs-meta"># yum install java-1.8.0-openjdk-src.x86_64</span><br><span class="hljs-meta"># java -version</span><br><span class="hljs-meta"># echo $JAVA_HOME</span><br>/usr/lib/jvm/jre<br></code></pre></td></tr></table></figure>

<p>解压并启动TC：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># tar zxvf TeamCity-10.0.1.tar.gz</span><br><span class="hljs-meta"># cd TeamCity</span><br><span class="hljs-meta"># cd bin/</span><br><span class="hljs-meta"># sh runAll.sh start</span><br></code></pre></td></tr></table></figure>

<p>下载连接数据库工具并拷贝到所需目录：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># wget https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-8.0.16.tar.gz</span><br><span class="hljs-meta"># tar zxvf mysql-connector-java-8.0.16.tar.gz</span><br><span class="hljs-meta"># cd mysql-connector-java-8.0.16</span><br><span class="hljs-meta"># cp mysql-connector-java-8.0.16.jar /root/.BuildServer/lib/jdbc/</span><br></code></pre></td></tr></table></figure>
<p><a href="https://postimg.cc/SYCbZpkM" target="_blank" rel="noopener"><img src="https://i.postimg.cc/QCnNdXz0/TC1.png" alt="TC1.png"></a><br><a href="https://postimg.cc/mcp4kwmt" target="_blank" rel="noopener"><img src="https://i.postimg.cc/G2dmMgYJ/TC2.png" alt="TC2.png"></a></p>
<p>创建还原备份的新目录并拷贝连接数据库工具到对应目录：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># mkdir <span class="hljs-regexp">/mnt/</span>restoretc<span class="hljs-regexp">/lib/</span>jdbc -p<br># cp -r <span class="hljs-regexp">/root/</span>.BuildServer<span class="hljs-regexp">/lib/</span>jdbc<span class="hljs-regexp">/mysql-connector-java-8.0.16.jar /m</span>nt<span class="hljs-regexp">/restoretc/</span>lib<span class="hljs-regexp">/jdbc/</span><br></code></pre></td></tr></table></figure>

<p>还原备份命令：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">-A 指定新路径	-F 指定备份数据路径		-T 指定数据库配置<br># <span class="hljs-keyword">sh</span> maintainDB.<span class="hljs-keyword">sh</span> <span class="hljs-keyword">restore</span> -A /mnt/restoretc -F /mnt/TeamCity_Backup_20190612_151253.<span class="hljs-keyword">zip</span> -T /mnt/database.properties<br></code></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"># cat /mnt/BuildServer/config/database.properties<br>#Thu Jun <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">48</span>:<span class="hljs-number">47</span> UTC <span class="hljs-number">2019</span><br>connectionProperties.user=root<br>connectionProperties.password=password<br>connectionUrl=jdbc\:mysql\:<span class="hljs-comment">///uu</span><br>[<span class="hljs-symbol">root@</span>ip<span class="hljs-number">-10</span><span class="hljs-number">-17</span><span class="hljs-number">-0</span><span class="hljs-number">-248</span> TeamCity]# cat  conf/teamcity-startup.properties<br>^[[A#Thu Jun <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">23</span> UTC <span class="hljs-number">2019</span><br>teamcity.data.path=/mnt/BuildServer<br></code></pre></td></tr></table></figure>

<p>还原后需修改目录名字为新的路径, 现在备份还原后数据存在，但是登录模块有问题,因为生产环境中登录接入了LDAP</p>
<p>踩过的坑：</p>
<ol>
<li>使用2018-02-24版本，不需要手动安装连接数据库的工具，还原时也不需要删除原来的数据库，只要新建新的数据库就行，但是因为生产中使用的TC版本太低，数据还原后会出现版本不支持数据无法显示的问题。</li>
<li>10.0.1版本还原时必须删除原始数据库并创建新的数据库才能正常导入。</li>
</ol>
<hr>
<p>#####TC备份还原后升级2018-02-24版本</p>
<ol>
<li>下载新版压缩包 # wget <a href="https://download.jetbrains.8686c.com/teamcity/TeamCity-2018.2.4.tar.gz" target="_blank" rel="noopener">https://download.jetbrains.8686c.com/teamcity/TeamCity-2018.2.4.tar.gz</a></li>
<li>解压并替换原目录，拷贝原目录下的配置文件到解压后的新目录 conf/teamcity-startup.properties，然后启动</li>
</ol>
<p>升级到新版后遇到的问题：<br>设置JVM内存,解决内存溢出问题 /data/TeamCity/bin/catalina.sh<br>升级后有一个自动重启的功能，使用原来命令stop不能停止，停掉就会立马重启一个</p>
<p><a href="https://postimg.cc/dhBwPvdR" target="_blank" rel="noopener"><img src="https://i.postimg.cc/HLGxMkkN/TC3.png" alt="TC3.png"></a><br><a href="https://postimg.cc/xk1Y97yw" target="_blank" rel="noopener"><img src="https://i.postimg.cc/SKWKfbXx/TC4.png" alt="TC4.png"></a><br><a href="https://postimg.cc/r0vLCpXT" target="_blank" rel="noopener"><img src="https://i.postimg.cc/L5s6SqxJ/TC5.png" alt="TC5.png"></a><br><a href="https://postimg.cc/ygJHZZGn" target="_blank" rel="noopener"><img src="https://i.postimg.cc/Pxyr0bQG/TC6.png" alt="TC6.png"></a></p>

      </section>

      <section class="article-footer">
        
      </section>

      <section class="article-navs">
        
<nav class="card-container card-article-nav">
  <div class="card-wrap">
    
      <div id="article-nav-newer" class="card-item">
        <article>
          
          <a class="card-link article-nav-link" href="/2019/06/20/55_jenkins%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/"></a>
          <strong class="article-nav-caption">Newer</strong>
          <p class="article-nav-title">
            
              jenkins在生产环境中的应用部署
            
          </p>
        </article>
      </div>
    
    
      <div id="article-nav-older" class="card-item">
        <article>
          
          <a class="card-link article-nav-link" href="/2019/06/12/53_sshpass/"></a>
          <strong class="article-nav-caption">Older</strong>
          <p class="article-nav-title">
            
              sshpass非交互式SSH密码验证
            
          </p>
        </article>
      </div>
    
  </div>
</nav>

      </section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons social-icons-footer">
      <a href="mailto:zhaodanwjk@163.com" target="_blank" rel="noopener noreferrer">
  <svg class="icon icon-email" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M490.338462 592.738462c11.815385 11.815385 29.538462 11.815385 41.353846 0l445.046154-413.538462c7.876923-15.753846 5.907692-41.353846-25.6-41.353846l-880.246154 1.969231c-23.630769 0-43.323077 21.661538-25.6 41.353846l445.046154 411.569231zM984.615385 340.676923c0-19.692308-23.630769-31.507692-39.384616-17.723077L596.676923 643.938462c-23.630769 21.661538-53.169231 33.476923-84.676923 33.476923s-61.046154-11.815385-84.676923-31.507693L80.738462 322.953846c-15.753846-13.784615-39.384615-3.938462-39.384616 17.723077C39.384615 334.769231 39.384615 787.692308 39.384615 787.692308c0 43.323077 35.446154 78.769231 78.769231 78.76923h787.692308c43.323077 0 78.769231-35.446154 78.769231-78.76923V340.676923z"></path>
  </svg>
</a><a href="https://www.instagram.com/hello_missdawn/" target="_blank" rel="noopener noreferrer">
  <svg class="icon icon-ins" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M512 0C372.906667 0 355.541333 0.64 300.928 3.072 246.4 5.632 209.28 14.208 176.64 26.88c-33.664 13.056-62.250667 30.592-90.709333 59.050667S39.893333 142.933333 26.88 176.64C14.208 209.28 5.589333 246.4 3.072 300.928 0.512 355.541333 0 372.906667 0 512s0.64 156.458667 3.072 211.072c2.56 54.485333 11.136 91.648 23.808 124.288a251.093333 251.093333 0 0 0 59.050667 90.709333A250.368 250.368 0 0 0 176.64 997.12c32.682667 12.629333 69.802667 21.290667 124.288 23.808C355.541333 1023.488 372.906667 1024 512 1024s156.458667-0.64 211.072-3.072c54.485333-2.56 91.648-11.178667 124.288-23.808a251.648 251.648 0 0 0 90.709333-59.050667 250.026667 250.026667 0 0 0 59.050667-90.709333c12.629333-32.64 21.290667-69.802667 23.808-124.288 2.56-54.613333 3.072-71.978667 3.072-211.072s-0.64-156.458667-3.072-211.072c-2.56-54.485333-11.178667-91.690667-23.808-124.288a251.306667 251.306667 0 0 0-59.050667-90.709333A249.472 249.472 0 0 0 847.36 26.88c-32.64-12.672-69.802667-21.290667-124.288-23.808C668.458667 0.512 651.093333 0 512 0z m0 92.16c136.661333 0 152.96 0.682667 206.933333 3.029333 49.92 2.346667 77.013333 10.624 95.018667 17.706667 23.978667 9.258667 40.96 20.352 58.965333 38.229333 17.877333 17.92 28.970667 34.944 38.229334 58.922667 6.997333 18.005333 15.36 45.098667 17.621333 95.018667 2.432 54.016 2.986667 70.229333 2.986667 206.933333s-0.64 152.96-3.157334 206.933333c-2.602667 49.92-10.922667 77.013333-17.962666 95.018667a162.56 162.56 0 0 1-38.357334 58.965333 159.744 159.744 0 0 1-58.88 38.229334c-17.92 6.997333-45.44 15.36-95.36 17.621333-54.357333 2.432-70.357333 2.986667-207.317333 2.986667-137.002667 0-153.002667-0.64-207.317333-3.157334-49.962667-2.602667-77.482667-10.922667-95.402667-17.962666a158.549333 158.549333 0 0 1-58.837333-38.357334 155.477333 155.477333 0 0 1-38.4-58.88c-7.04-17.92-15.317333-45.44-17.92-95.36-1.92-53.76-2.602667-70.357333-2.602667-206.677333 0-136.362667 0.682667-153.002667 2.602667-207.402667 2.602667-49.92 10.88-77.397333 17.92-95.317333 8.96-24.32 20.437333-40.96 38.4-58.922667 17.877333-17.877333 34.56-29.397333 58.837333-38.314666 17.92-7.082667 44.842667-15.402667 94.762667-17.962667 54.4-1.92 70.4-2.56 207.317333-2.56l1.92 1.28z m0 156.928a262.912 262.912 0 1 0 0 525.824 262.912 262.912 0 1 0 0-525.824zM512 682.666667c-94.293333 0-170.666667-76.373333-170.666667-170.666667s76.373333-170.666667 170.666667-170.666667 170.666667 76.373333 170.666667 170.666667-76.373333 170.666667-170.666667 170.666667z m334.762667-443.946667a61.482667 61.482667 0 0 1-122.88 0 61.44 61.44 0 0 1 122.88 0z"></path>
  </svg>
</a>
    </div>
     
    <p>&copy; 2020 <a href="/" target="_blank">dandan</a></p>

    
      <p id="hitokoto"></p>
      <script src="https://v1.hitokoto.cn/?c=c&amp;encode=js&select=%23hitokoto" defer></script>
    

    

    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank">flex-block</a></p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
  <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
  <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
</svg> 
  </div>

  
  
<!-- valine 评论 start -->
<script type="text/javascript" src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script type="text/javascript">
  new Valine({
    el: "#valine_thread",
    appId: "1x2m86DzLyVjjvrAd28PlcHP-9Nh9j0Va",
    appKey: "rOyvhDLkseoPCv9tY592cNVW",
    avatar: "mm",
    placeholder: "随便说点什么叭～",
    notify: true,
    visitor: true,
    pageSize: 10,
  });
</script>
<!-- valine 评论 end -->



  <!-- aplayer 音频 start -->
  
<link rel="stylesheet" href="/lib/APlayer.min.css">

  
<script src="/lib/APlayer.min.js"></script>

  <script type="text/javascript">
    const aplayer = document.querySelectorAll(".aplayer");
    aplayer && initaplayer(aplayer);
    function initaplayer(els) {
      let elsArr = Array.from(els);
      elsArr.forEach(el => {
        new APlayer({
          container: el,
          audio: { ...el.dataset },
          theme: "#b7daff",
          lrcType: 3,
          autoplay: false,
          loop: false,
          mutex: true,
        });
      });
    }
  </script>
  <!-- aplayer 音频 end -->
  

<!-- dplayer 视频 start -->

<link rel="stylesheet" href="/lib/DPlayer.min.css">


<script src="/lib/DPlayer.min.js"></script>

<script type="text/javascript">
  const dplayer = document.querySelectorAll(".dplayer");
  dplayer && initDPlayer(dplayer);
  function initDPlayer(els) {
    let elsArr = Array.from(els);
    elsArr.forEach(el => {
      let url = el.dataset.url;
      let cover = el.dataset.cover;
      new DPlayer({
        container: el,
        video: { url: url, pic: cover },
        theme: "#b7daff",
        autoplay: false,
        loop: false,
        mutex: true,
      });
    });
  }
</script>
<!-- dplayer 视频 end -->


<!-- waterfall 瀑布流 start -->

<script src="/lib/waterfall.min.js"></script>

<script type="text/javascript">

const waterfalls = document.querySelectorAll(".waterfall-container");

if (waterfalls && waterfalls.length > 0) {
  waterfalls.forEach((waterfall, index) => {
    let cls = "waterfall-container-" + index;
    waterfall.classList.add(cls);
    initWaterfall(cls, waterfall);
  });
}

function initWaterfall(selector, el) {
  const options = {};
  if (Object.keys(el.dataset).length > 0) {
    for (let k in el.dataset) {
      options[k] = el.dataset[k];
    }
  }
  waterfall(`.${selector}`, options);
}
</script>
<!-- waterfall 瀑布流 end -->


  <!-- zoom start -->
  
<script src="/lib/zoom.min.js"></script>

  <script type="text/javascript">
    document.querySelector(".article-content") && zoom(".article-content");
  </script>
  <!-- zoom end -->
  



  


  


  




<script src="/js/script.js"></script>

  
  <!-- 尾部用户自定义相关内容 -->

</body>
</html>